stages:
  - verify
  - lint
  - build
  - package
  - release

# global cache configuration for bun jobs
.bun_cache: &bun_cache
  cache:
    key:
      files:
        - bun.lockb
    paths:
      - node_modules/

# verify version was incremented and extract version variables
verify-version:
  stage: verify
  image: oven/bun:latest
  before_script:
    - apk add --no-cache git jq
  script:
    - CURRENT_VERSION=$(jq -r '.version' package.json)
    - echo "Current version is ${CURRENT_VERSION}"
    - PREVIOUS_VERSION=$(git show HEAD~1:package.json | jq -r '.version')
    - echo "Previous version was ${PREVIOUS_VERSION}"
    - |
      if [ "$CURRENT_VERSION" = "$PREVIOUS_VERSION" ]; then
        echo "ERROR: Version was not incremented! Please ensure the pre-commit hook ran."
        echo "Current: $CURRENT_VERSION, Previous: $PREVIOUS_VERSION"
        exit 1
      fi
    - echo "Version was properly incremented: ${PREVIOUS_VERSION} â†’ ${CURRENT_VERSION}"
    - MAJOR_VERSION=$(echo $CURRENT_VERSION | cut -d. -f1)
    - RELEASE_VERSION="r${MAJOR_VERSION}"
    - echo "RELEASE_VERSION=${RELEASE_VERSION}" >> version.env
    - echo "SEMVER_VERSION=${CURRENT_VERSION}" >> version.env
    - cat version.env
  artifacts:
    reports:
      dotenv: version.env
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# lint and type check
lint:
  stage: lint
  image: oven/bun:latest
  <<: *bun_cache
  script:
    - bun install --frozen-lockfile
    - bun run typecheck
    - bun run lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# build both chrome and firefox versions with version injection
build:
  stage: build
  image: oven/bun:latest
  <<: *bun_cache
  needs:
    - job: verify-version
      artifacts: true
  script:
    - bun install --frozen-lockfile
    - bun run build
    - echo "Injecting version ${SEMVER_VERSION} into manifests"
    - 'sed -i "s/\"version\": \".*\"/\"version\": \"${SEMVER_VERSION}\"/" dist/chrome/manifest.json'
    - 'sed -i "s/\"version\": \".*\"/\"version\": \"${SEMVER_VERSION}\"/" dist/firefox/manifest.json'
    - echo "BUILD_JOB_ID=${CI_JOB_ID}" >> build.env
  artifacts:
    paths:
      - dist/chrome/
      - dist/firefox/
    expire_in: 30 days
    reports:
      dotenv: build.env
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# package chrome extension as zip
package-chrome:
  stage: package
  image: alpine:latest
  cache:
    key: apk-cache
    paths:
      - .apk-cache/
  needs:
    - job: verify-version
      artifacts: true
    - job: build
      artifacts: true
  before_script:
    - mkdir -p .apk-cache
    - ln -s "$(pwd)/.apk-cache" /etc/apk/cache
    - apk add zip
  script:
    - cd dist/chrome
    - zip -r ../../xblockorigin-chrome-${RELEASE_VERSION}.zip .
    - cd ../..
    - echo "Chrome extension packaged as xblockorigin-chrome-${RELEASE_VERSION}.zip"
    - echo "CHROME_JOB_ID=${CI_JOB_ID}" >> package-chrome.env
  artifacts:
    paths:
      - xblockorigin-chrome-${RELEASE_VERSION}.zip
    expire_in: 30 days
    reports:
      dotenv: package-chrome.env
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# package firefox extension (unsigned)
package-firefox:
  stage: package
  image: node:20-alpine
  cache:
    key: npm-global-cache
    paths:
      - .npm-global/
  needs:
    - job: verify-version
      artifacts: true
    - job: build
      artifacts: true
  before_script:
    - mkdir -p .npm-global
    - npm config set prefix "$(pwd)/.npm-global"
    - export PATH="$(pwd)/.npm-global/bin:${PATH}"
    - npm install -g web-ext
  script:
    - cd dist/firefox
    - echo "Building unsigned Firefox extension..."
    - web-ext build --overwrite-dest --artifacts-dir=../../
    - mv ../../*.zip ../../xblockorigin-firefox-${RELEASE_VERSION}.zip || true
    - cd ../..
    - ls -lh xblockorigin-firefox-*
    - echo "Note Extension is unsigned. See README for installation instructions."
    - echo "FIREFOX_JOB_ID=${CI_JOB_ID}" >> package-firefox.env
  artifacts:
    paths:
      - xblockorigin-firefox-*.zip
    expire_in: 30 days
    reports:
      dotenv: package-firefox.env
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# create gitlab release with artifacts
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: verify-version
      artifacts: true
    - job: build
      artifacts: true
    - job: package-chrome
      artifacts: true
    - job: package-firefox
      artifacts: true
  script:
    - echo "Creating release ${RELEASE_VERSION}"
  release:
    name: 'Release ${RELEASE_VERSION}'
    tag_name: '${RELEASE_VERSION}'
    description: 'Release ${RELEASE_VERSION} built from commit ${CI_COMMIT_SHORT_SHA}. Both extensions are UNSIGNED for personal/testing use only. See README for installation instructions.'
    assets:
      links:
        - name: "xBlockOrigin Chrome Extension (unsigned)"
          url: "${CI_PROJECT_URL}/-/jobs/${CHROME_JOB_ID}/artifacts/raw/xblockorigin-chrome-${RELEASE_VERSION}.zip"
          link_type: package
        - name: "xBlockOrigin Firefox Extension (unsigned)"
          url: "${CI_PROJECT_URL}/-/jobs/${FIREFOX_JOB_ID}/artifacts/raw/xblockorigin-firefox-${RELEASE_VERSION}.zip"
          link_type: package
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
