name: CI/CD Pipeline

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  verify-version:
    name: Verify Version
    runs-on: ubuntu-latest
    outputs:
      release_version: ${{ steps.extract.outputs.release_version }}
      semver_version: ${{ steps.extract.outputs.semver_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Extract and verify version
        id: extract
        run: |
          # extract current version
          CURRENT_VERSION=$(jq -r '.version' package.json)
          echo "Current version is ${CURRENT_VERSION}"

          # extract previous version from last commit
          PREVIOUS_VERSION=$(git show HEAD~1:package.json | jq -r '.version')
          echo "Previous version was ${PREVIOUS_VERSION}"

          # fail if version wasn't incremented (only on main branch)
          if [ "${{ github.ref }}" = "refs/heads/master" ]; then
            if [ "$CURRENT_VERSION" = "$PREVIOUS_VERSION" ]; then
              echo "ERROR: Version was not incremented! Please ensure the pre-commit hook ran."
              echo "Current: $CURRENT_VERSION, Previous: $PREVIOUS_VERSION"
              exit 1
            fi
            echo "Version was properly incremented: ${PREVIOUS_VERSION} â†’ ${CURRENT_VERSION}"
          fi

          # extract major version for release tag
          MAJOR_VERSION=$(echo $CURRENT_VERSION | cut -d. -f1)
          RELEASE_VERSION="r${MAJOR_VERSION}"

          echo "release_version=${RELEASE_VERSION}" >> $GITHUB_OUTPUT
          echo "semver_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT

  lint:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Type check
        run: bun run typecheck

      - name: Lint
        run: bun run lint

  build:
    name: Build Extensions
    runs-on: ubuntu-latest
    needs: verify-version
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build

      - name: Inject version into manifests
        run: |
          echo "Injecting version ${{ needs.verify-version.outputs.semver_version }} into manifests"
          sed -i "s/\"version\": \".*\"/\"version\": \"${{ needs.verify-version.outputs.semver_version }}\"/" dist/chrome/manifest.json
          sed -i "s/\"version\": \".*\"/\"version\": \"${{ needs.verify-version.outputs.semver_version }}\"/" dist/firefox/manifest.json

      - name: Upload Chrome build
        uses: actions/upload-artifact@v4
        with:
          name: chrome-build
          path: dist/chrome/
          retention-days: 30

      - name: Upload Firefox build
        uses: actions/upload-artifact@v4
        with:
          name: firefox-build
          path: dist/firefox/
          retention-days: 30

  package-chrome:
    name: Package Chrome Extension
    runs-on: ubuntu-latest
    needs: [verify-version, build]
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Download Chrome build
        uses: actions/download-artifact@v4
        with:
          name: chrome-build
          path: dist/chrome

      - name: Create Chrome zip
        run: |
          cd dist/chrome
          zip -r ../../xblockorigin-chrome-${{ needs.verify-version.outputs.release_version }}.zip .
          cd ../..
          echo "Chrome extension packaged as xblockorigin-chrome-${{ needs.verify-version.outputs.release_version }}.zip"

      - name: Upload Chrome package
        uses: actions/upload-artifact@v4
        with:
          name: chrome-package
          path: xblockorigin-chrome-${{ needs.verify-version.outputs.release_version }}.zip
          retention-days: 30

  package-firefox:
    name: Package Firefox Extension
    runs-on: ubuntu-latest
    needs: [verify-version, build]
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Download Firefox build
        uses: actions/download-artifact@v4
        with:
          name: firefox-build
          path: dist/firefox

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install web-ext
        run: npm install -g web-ext

      - name: Build Firefox package
        run: |
          cd dist/firefox
          echo "Building unsigned Firefox extension..."
          web-ext build --overwrite-dest --artifacts-dir=../../
          mv ../../*.zip ../../xblockorigin-firefox-${{ needs.verify-version.outputs.release_version }}.zip || true
          cd ../..
          ls -lh xblockorigin-firefox-*
          echo "Note: Extension is unsigned. See README for installation instructions."

      - name: Upload Firefox package
        uses: actions/upload-artifact@v4
        with:
          name: firefox-package
          path: xblockorigin-firefox-*.zip
          retention-days: 30

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [verify-version, package-chrome, package-firefox]
    if: github.ref == 'refs/heads/master'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Chrome package
        uses: actions/download-artifact@v4
        with:
          name: chrome-package

      - name: Download Firefox package
        uses: actions/download-artifact@v4
        with:
          name: firefox-package

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.verify-version.outputs.release_version }}
          name: Release ${{ needs.verify-version.outputs.release_version }}
          body: |
            Release ${{ needs.verify-version.outputs.release_version }} built from commit ${{ github.sha }}.

            Both extensions are UNSIGNED for personal/testing use only. See README for installation instructions.
          files: |
            xblockorigin-chrome-${{ needs.verify-version.outputs.release_version }}.zip
            xblockorigin-firefox-${{ needs.verify-version.outputs.release_version }}.zip
          draft: false
          prerelease: false
